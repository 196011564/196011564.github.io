<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CTF-Pwn-dl_resolve详解 | 咲夜南梦's 博客</title><meta name="description" content="CTF-Pwn-dl_resolve详解"><meta name="keywords" content="CTF,Pwn"><meta name="author" content="咲夜南梦,196011564@qq.com"><meta name="copyright" content="咲夜南梦"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CTF-Pwn-dl_resolve详解"><meta name="twitter:description" content="CTF-Pwn-dl_resolve详解"><meta name="twitter:image" content="http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/11.png"><meta property="og:type" content="article"><meta property="og:title" content="CTF-Pwn-dl_resolve详解"><meta property="og:url" content="http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="咲夜南梦's 博客"><meta property="og:description" content="CTF-Pwn-dl_resolve详解"><meta property="og:image" content="http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/11.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/"><link rel="prev" title="Python-subprocess模块详解" href="http://yoursite.com/2020/02/14/Python-subprocess%E6%A8%A1%E5%9D%97%E8%AF%A6%E8%A7%A3/"><link rel="next" title="CTF堆攻击大全" href="http://yoursite.com/2020/01/30/CTF%E5%A0%86%E6%94%BB%E5%87%BB%E5%A4%A7%E5%85%A8/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="咲夜南梦's 博客" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">134</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">47</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 额外功能</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#null"><span class="toc-number">1.</span> <span class="toc-text">CTF-Pwn-dl_resolve详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#近期对于dl-resolve不大熟练，所以准备整理一份比较完整资料来学习一波，以源码和实践相互结合分析，逐渐深入。"><span class="toc-number">1.1.</span> <span class="toc-text">近期对于dl-resolve不大熟练，所以准备整理一份比较完整资料来学习一波，以源码和实践相互结合分析，逐渐深入。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#首先我编译了一份简单的elf文件，然后通过ida在load段看到了如下的数据"><span class="toc-number">1.1.1.</span> <span class="toc-text">首先我编译了一份简单的elf文件，然后通过ida在load段看到了如下的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从上面的数据中我们不难看出Elf32-Sym的结构体如下"><span class="toc-number">1.1.2.</span> <span class="toc-text">从上面的数据中我们不难看出Elf32_Sym的结构体如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#先对于-Elf32-Word-st-name-如何算出来的"><span class="toc-number">1.1.3.</span> <span class="toc-text">先对于  Elf32_Word    st_name  如何算出来的?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序编译的时候设置了一个被调用函数名字符串的基址，就是下面这个地址，下面的数据可以在上面呈现的代码中找到"><span class="toc-number">1.1.4.</span> <span class="toc-text">程序编译的时候设置了一个被调用函数名字符串的基址，就是下面这个地址，下面的数据可以在上面呈现的代码中找到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#所以-st-name-被调用函数名字符串地址-基址"><span class="toc-number">1.1.5.</span> <span class="toc-text">所以 st_name &#x3D; 被调用函数名字符串地址 - 基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比如上述代码的printf的-st-name-应该等于-0x080482F3-080482CC-0x27-，刚好第一位数字就是0x27"><span class="toc-number">1.1.6.</span> <span class="toc-text">比如上述代码的printf的  st_name   应该等于[0x080482F3 - 080482CC &#x3D; 0x27]，刚好第一位数字就是0x27</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1、st-name表示符号名，这里的值是它在相应字符串表中的索引号。如-dynsym-section中所有表项的符号名要从-dynstr-section中获取，而-symtab是从-strtab中获取。而-dynstr和-strtab都是字符串表。"><span class="toc-number">1.1.7.</span> <span class="toc-text">1、st_name表示符号名，这里的值是它在相应字符串表中的索引号。如.dynsym section中所有表项的符号名要从.dynstr section中获取，而.symtab是从.strtab中获取。而.dynstr和.strtab都是字符串表。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、st-value表示符号的值。一般为虚拟地址。"><span class="toc-number">1.1.8.</span> <span class="toc-text">2、st_value表示符号的值。一般为虚拟地址。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、st-size表示符号的大小。比如对于变量，它的值就是变量的数据类型（如int则它的值可能为4个字节）的大小。如果为0则表示该符号无需大小或大小未知。"><span class="toc-number">1.1.9.</span> <span class="toc-text">3、st_size表示符号的大小。比如对于变量，它的值就是变量的数据类型（如int则它的值可能为4个字节）的大小。如果为0则表示该符号无需大小或大小未知。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、st-info表示符号的类型和绑定特征。成员st-info的大小为一个字节，低4位表示符号类型，高4位表示符号的绑定特征。在-usr-include-elf-h文件中，有定义以下三个宏来获取类型或绑定特征的值或将它俩合成st-info的值："><span class="toc-number">1.1.10.</span> <span class="toc-text">4、st_info表示符号的类型和绑定特征。成员st_info的大小为一个字节，低4位表示符号类型，高4位表示符号的绑定特征。在&#x2F;usr&#x2F;include&#x2F;elf.h文件中，有定义以下三个宏来获取类型或绑定特征的值或将它俩合成st_info的值：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-、绑定特征的可能取值如下所示："><span class="toc-number">1.1.11.</span> <span class="toc-text">(1)、绑定特征的可能取值如下所示：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#STB-LOCAL表示局部符号，STB-GLOBAL表示全局符号，STB-WEAK表示弱符号。"><span class="toc-number">1.1.11.1.</span> <span class="toc-text">STB_LOCAL表示局部符号，STB_GLOBAL表示全局符号，STB_WEAK表示弱符号。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#弱符号是全局符号，但它们的优先级相对全局符号低。"><span class="toc-number">1.1.11.2.</span> <span class="toc-text">弱符号是全局符号，但它们的优先级相对全局符号低。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#局部符号，顾名思义，它只被局限在定义它的目标文件之内，多个目标文件定义的同名局部符号互不影响，全局符号则与之相反。"><span class="toc-number">1.1.11.3.</span> <span class="toc-text">局部符号，顾名思义，它只被局限在定义它的目标文件之内，多个目标文件定义的同名局部符号互不影响，全局符号则与之相反。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#相对弱符号，其它的就是强符号。两个同名的强符号会导致重复定义的错误，但如果同名的是一个强符号和多个弱符号，则不报错，链接器会选择其中的强符号。"><span class="toc-number">1.1.11.4.</span> <span class="toc-text">相对弱符号，其它的就是强符号。两个同名的强符号会导致重复定义的错误，但如果同名的是一个强符号和多个弱符号，则不报错，链接器会选择其中的强符号。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-、符号类型的可能取值如下所示："><span class="toc-number">1.1.12.</span> <span class="toc-text">(2)、符号类型的可能取值如下所示：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#STT-NOTYPE表示未指定类型。每个符号表开头都有一个该类型的表项。"><span class="toc-number">1.1.12.1.</span> <span class="toc-text">STT_NOTYPE表示未指定类型。每个符号表开头都有一个该类型的表项。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STT-OBJECT表示数据，如变量、数组等。"><span class="toc-number">1.1.12.2.</span> <span class="toc-text">STT_OBJECT表示数据，如变量、数组等。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STT-FUNC表示函数或可执行代码。"><span class="toc-number">1.1.12.3.</span> <span class="toc-text">STT_FUNC表示函数或可执行代码。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STT-SECTION表示一个section，该类型符号的绑定特征是STB-LOCAL。"><span class="toc-number">1.1.12.4.</span> <span class="toc-text">STT_SECTION表示一个section，该类型符号的绑定特征是STB_LOCAL。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STT-FILE表示文件名。该类型符号的绑定特征是STB-LOCAL，st-shndx的值为SHN-ABS。"><span class="toc-number">1.1.12.5.</span> <span class="toc-text">STT_FILE表示文件名。该类型符号的绑定特征是STB_LOCAL，st_shndx的值为SHN_ABS。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、st-other表示符号的可见性，只使用了该成员的低2位。它的可能取值如下所示："><span class="toc-number">1.1.13.</span> <span class="toc-text">5、st_other表示符号的可见性，只使用了该成员的低2位。它的可能取值如下所示：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、st-shndx表示符号所在的section对应的section-header的索引号。它有以下三个特殊值："><span class="toc-number">1.1.14.</span> <span class="toc-text">6、st_shndx表示符号所在的section对应的section header的索引号。它有以下三个特殊值：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SHN-UNDEF表示该符号是未定义的，也就是说它可能定义在其他目标文件中，只有在程序执行时才能实际确定。对于索引值为STN-UNDEF的表项，st-shndx的值也是SHN-UNDEF。"><span class="toc-number">1.1.14.1.</span> <span class="toc-text">SHN_UNDEF表示该符号是未定义的，也就是说它可能定义在其他目标文件中，只有在程序执行时才能实际确定。对于索引值为STN_UNDEF的表项，st_shndx的值也是SHN_UNDEF。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SHN-ABS表示该符号的值在重定位时不会改变。"><span class="toc-number">1.1.14.2.</span> <span class="toc-text">SHN_ABS表示该符号的值在重定位时不会改变。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SHN-COMMON表示该符号尚未被分配空间，它的值st-value为地址对齐字节数。"><span class="toc-number">1.1.14.3.</span> <span class="toc-text">SHN_COMMON表示该符号尚未被分配空间，它的值st_value为地址对齐字节数。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对于pwn来说，总之我们这里只要考虑st-name-st-info"><span class="toc-number">1.1.15.</span> <span class="toc-text">对于pwn来说，总之我们这里只要考虑st_name, st_info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#我们抽取最一般的规律，如下"><span class="toc-number">1.1.16.</span> <span class="toc-text">我们抽取最一般的规律，如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对于其他的数据统统为0，如下"><span class="toc-number">1.1.17.</span> <span class="toc-text">对于其他的数据统统为0，如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#这样我们学好了-dynstr和-dynsym结构体的知识"><span class="toc-number">1.1.18.</span> <span class="toc-text">这样我们学好了.dynstr和.dynsym结构体的知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接着我们学习-rel-plt，接着通过ida找到下面的数据，如下"><span class="toc-number">1.1.19.</span> <span class="toc-text">接着我们学习.rel.plt，接着通过ida找到下面的数据，如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#以上数据就是-rel-plt，从中我们可以提取出一个结构体，如下"><span class="toc-number">1.1.20.</span> <span class="toc-text">以上数据就是.rel.plt，从中我们可以提取出一个结构体，如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单说r-offset就是got地址"><span class="toc-number">1.1.21.</span> <span class="toc-text">简单说r_offset就是got地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接下来稍微简单说一下r-info"><span class="toc-number">1.1.22.</span> <span class="toc-text">接下来稍微简单说一下r_info</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#r-info最低位为6则是变量，为7则是函数"><span class="toc-number">1.1.22.1.</span> <span class="toc-text">r_info最低位为6则是变量，为7则是函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#r-info第二位开始为-dynsym的位置，这个位置是以下代码的位置开始的，其实本质上就是-dynsym的头部，然后相对于这个头部取偏移，然后每个偏移的长度为0x10，因为一个-dynsym的长度为0x10"><span class="toc-number">1.1.22.2.</span> <span class="toc-text">r_info第二位开始为.dynsym的位置，这个位置是以下代码的位置开始的，其实本质上就是.dynsym的头部，然后相对于这个头部取偏移，然后每个偏移的长度为0x10，因为一个.dynsym的长度为0x10</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#所以总结一下"><span class="toc-number">1.1.23.</span> <span class="toc-text">所以总结一下</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#如果要绑定变量-r-info-fake-dynsym-dynsym-head-0x10-8-0x6"><span class="toc-number">1.1.23.1.</span> <span class="toc-text">如果要绑定变量 r_info &#x3D; (((fake_dynsym - dynsym_head) &#x2F; 0x10) &lt;&lt; 8) | 0x6;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如果要绑定函数-r-info-fake-dynsym-dynsym-head-0x10-8-0x7"><span class="toc-number">1.1.23.2.</span> <span class="toc-text">如果要绑定函数 r_info &#x3D; (((fake_dynsym - dynsym_head) &#x2F; 0x10) &lt;&lt; 8) | 0x7</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接下来就是reloc-offset的取值问题"><span class="toc-number">1.1.24.</span> <span class="toc-text">接下来就是reloc_offset的取值问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#这里直接给出规律-reloc-offset-fake-rel-plt-rel-plt-head"><span class="toc-number">1.1.24.1.</span> <span class="toc-text">这里直接给出规律 reloc_offset &#x3D; fake_rel_plt - rel_plt_head</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结一下结构体伪造的步骤"><span class="toc-number">1.1.25.</span> <span class="toc-text">总结一下结构体伪造的步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、在bss段构造dynsym顺便把函数名也放到后面，接着继续在函数名后面继续构造-rel-plt"><span class="toc-number">1.1.25.1.</span> <span class="toc-text">1、在bss段构造dynsym顺便把函数名也放到后面，接着继续在函数名后面继续构造.rel.plt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、通过栈迁移，将reloc-offset和参数放到栈的位置里，然后跳到plt-jmp绑定函数的plt上就可以触发dl-runtime-resolve然后通过-fix-up来任意函数调用"><span class="toc-number">1.1.25.2.</span> <span class="toc-text">2、通过栈迁移，将reloc_offset和参数放到栈的位置里，然后跳到plt_jmp绑定函数的plt上就可以触发dl_runtime_resolve然后通过_fix_up来任意函数调用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考了部分原文链接：https-blog-csdn-net-npy-lp-article-details-102704732"><span class="toc-number">1.1.26.</span> <span class="toc-text">参考了部分原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;npy_lp&#x2F;article&#x2F;details&#x2F;102704732</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/2020/02/07/CTF-Pwn-dl_resolve详解/11.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">咲夜南梦's 博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 额外功能</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">CTF-Pwn-dl_resolve详解</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-02-07<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-19</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1>CTF-Pwn-dl_resolve详解</h1>
<hr>
<h2 id="近期对于dl-resolve不大熟练，所以准备整理一份比较完整资料来学习一波，以源码和实践相互结合分析，逐渐深入。">近期对于dl-resolve不大熟练，所以准备整理一份比较完整资料来学习一波，以源码和实践相互结合分析，逐渐深入。</h2>
<h3 id="首先我编译了一份简单的elf文件，然后通过ida在load段看到了如下的数据">首先我编译了一份简单的elf文件，然后通过ida在load段看到了如下的数据</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804820C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                 Elf32_Sym &lt;0&gt;</span><br><span class="line">LOAD:0804821C 49 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aSetbuf - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;setbuf&quot;</span><br><span class="line">LOAD:0804822C 36 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aRead - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;read&quot;</span><br><span class="line">LOAD:0804823C 27 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aPrintf - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;printf&quot;</span><br><span class="line">LOAD:0804824C 42 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00                 Elf32_Sym &lt;offset aStderr - offset unk_80482CC, 0, 0, 11h, 0, 0&gt; ; &quot;stderr&quot;</span><br><span class="line">LOAD:0804825C 2E 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aGetchar - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;getchar&quot;</span><br><span class="line">LOAD:0804826C 20 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aGetpid - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;getpid&quot;</span><br><span class="line">LOAD:0804827C 6C 00 00 00 00 00 00 00 00 00 00 00 20 00 00 00                 Elf32_Sym &lt;offset aGmonStart - offset unk_80482CC, 0, 0, 20h, 0, 0&gt; ; &quot;__gmon_start__&quot;</span><br><span class="line">LOAD:0804828C 50 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aLibcStartMain - offset unk_80482CC, 0, 0, 12h, 0, \ ; &quot;__libc_start_main&quot;</span><br><span class="line">LOAD:0804828C                                                                            0&gt;</span><br><span class="line">LOAD:0804829C 1A 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00                 Elf32_Sym &lt;offset aStdin - offset unk_80482CC, 0, 0, 11h, 0, 0&gt; ; &quot;stdin&quot;</span><br><span class="line">LOAD:080482AC 3B 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00                 Elf32_Sym &lt;offset aStdout - offset unk_80482CC, 0, 0, 11h, 0, 0&gt; ; &quot;stdout&quot;</span><br><span class="line">LOAD:080482BC 0B 00 00 00 04 A0 04 08 04 00 00 00 11 00 0F 00                 Elf32_Sym &lt;offset aIoStdinUsed - offset unk_80482CC, \ ; &quot;_IO_stdin_used&quot;</span><br><span class="line">LOAD:080482BC                                                                            offset _IO_stdin_used, 4, 11h, 0, 0Fh&gt;</span><br><span class="line">LOAD:080482CC                                                 ; ELF String Table</span><br><span class="line">LOAD:080482CC 00                                              unk_80482CC     db    0                 ; DATA XREF: LOAD:0804821C↑o</span><br><span class="line">LOAD:080482CC                                                                                         ; LOAD:0804822C↑o ...</span><br><span class="line">LOAD:080482CD 6C 69 62 63 2E 73 6F 2E 36 00                   aLibcSo6        db &#39;libc.so.6&#39;,0</span><br><span class="line">LOAD:080482D7 5F 49 4F 5F 73 74 64 69 6E 5F 75 73 65 64 00    aIoStdinUsed    db &#39;_IO_stdin_used&#39;,0   ; DATA XREF: LOAD:080482BC↑o</span><br><span class="line">LOAD:080482E6 73 74 64 69 6E 00                               aStdin          db &#39;stdin&#39;,0            ; DATA XREF: LOAD:0804829C↑o</span><br><span class="line">LOAD:080482EC 67 65 74 70 69 64 00                            aGetpid         db &#39;getpid&#39;,0           ; DATA XREF: LOAD:0804826C↑o</span><br><span class="line">LOAD:080482F3 70 72 69 6E 74 66 00                            aPrintf         db &#39;printf&#39;,0           ; DATA XREF: LOAD:0804823C↑o</span><br><span class="line">LOAD:080482FA 67 65 74 63 68 61 72 00                         aGetchar        db &#39;getchar&#39;,0          ; DATA XREF: LOAD:0804825C↑o</span><br><span class="line">LOAD:08048302 72 65 61 64 00                                  aRead           db &#39;read&#39;,0             ; DATA XREF: LOAD:0804822C↑o</span><br><span class="line">LOAD:08048307 73 74 64 6F 75 74 00                            aStdout         db &#39;stdout&#39;,0           ; DATA XREF: LOAD:080482AC↑o</span><br><span class="line">LOAD:0804830E 73 74 64 65 72 72 00                            aStderr         db &#39;stderr&#39;,0           ; DATA XREF: LOAD:0804824C↑o</span><br><span class="line">LOAD:08048315 73 65 74 62 75 66 00                            aSetbuf         db &#39;setbuf&#39;,0           ; DATA XREF: LOAD:0804821C↑o</span><br><span class="line">LOAD:0804831C 5F 5F 6C 69 62 63 5F 73 74 61 72 74 5F 6D 61 69+aLibcStartMain  db &#39;__libc_start_main&#39;,0</span><br><span class="line">LOAD:0804831C 6E 00                                                                                   ; DATA XREF: LOAD:0804828C↑o</span><br><span class="line">LOAD:0804832E 47 4C 49 42 43 5F 32 2E 30 00                   aGlibc20        db &#39;GLIBC_2.0&#39;,0</span><br><span class="line">LOAD:08048338 5F 5F 67 6D 6F 6E 5F 73 74 61 72 74 5F 5F 00    aGmonStart      db &#39;__gmon_start__&#39;,0   ; DATA XREF:</span><br></pre></td></tr></table></figure>
<h3 id="从上面的数据中我们不难看出Elf32-Sym的结构体如下">从上面的数据中我们不难看出Elf32_Sym的结构体如下</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    st_name;         &#x2F;4字节* Symbol name (string tbl index) *&#x2F;</span><br><span class="line">  Elf32_Addr    st_value;        &#x2F;4字节* Symbol value *&#x2F;</span><br><span class="line">  Elf32_Word    st_size;         &#x2F;4字节* Symbol size *&#x2F;</span><br><span class="line">  unsigned char    st_info;      &#x2F;1字节* Symbol type and binding *&#x2F;</span><br><span class="line">  unsigned char    st_other;     &#x2F;1字节* Symbol visibility *&#x2F;</span><br><span class="line">  Elf32_Section    st_shndx;     &#x2F;2字节* Section index *&#x2F;</span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>
<h3 id="先对于-Elf32-Word-st-name-如何算出来的">先对于  <code>Elf32_Word    st_name</code>  如何算出来的?</h3>
<h3 id="程序编译的时候设置了一个被调用函数名字符串的基址，就是下面这个地址，下面的数据可以在上面呈现的代码中找到">程序编译的时候设置了一个被调用函数名字符串的基址，就是下面这个地址，下面的数据可以在上面呈现的代码中找到</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080482CC                                                 ; ELF String Table</span><br></pre></td></tr></table></figure>
<h3 id="所以-st-name-被调用函数名字符串地址-基址">所以 <code>st_name</code> = 被调用函数名字符串地址 - 基址</h3>
<h3 id="比如上述代码的printf的-st-name-应该等于-0x080482F3-080482CC-0x27-，刚好第一位数字就是0x27">比如上述代码的printf的  <code>st_name </code>  应该等于[0x080482F3 - 080482CC = 0x27]，刚好第一位数字就是0x27</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804823C 27 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00                 Elf32_Sym &lt;offset aPrintf - offset unk_80482CC, 0, 0, 12h, 0, 0&gt; ; &quot;printf&quot;</span><br></pre></td></tr></table></figure>
<h3 id="1、st-name表示符号名，这里的值是它在相应字符串表中的索引号。如-dynsym-section中所有表项的符号名要从-dynstr-section中获取，而-symtab是从-strtab中获取。而-dynstr和-strtab都是字符串表。">1、st_name表示符号名，这里的值是它在相应字符串表中的索引号。如.dynsym section中所有表项的符号名要从.dynstr section中获取，而.symtab是从.strtab中获取。而.dynstr和.strtab都是字符串表。</h3>
<h3 id="2、st-value表示符号的值。一般为虚拟地址。">2、st_value表示符号的值。一般为虚拟地址。</h3>
<h3 id="3、st-size表示符号的大小。比如对于变量，它的值就是变量的数据类型（如int则它的值可能为4个字节）的大小。如果为0则表示该符号无需大小或大小未知。">3、st_size表示符号的大小。比如对于变量，它的值就是变量的数据类型（如int则它的值可能为4个字节）的大小。如果为0则表示该符号无需大小或大小未知。</h3>
<h3 id="4、st-info表示符号的类型和绑定特征。成员st-info的大小为一个字节，低4位表示符号类型，高4位表示符号的绑定特征。在-usr-include-elf-h文件中，有定义以下三个宏来获取类型或绑定特征的值或将它俩合成st-info的值：">4、st_info表示符号的类型和绑定特征。成员st_info的大小为一个字节，低4位表示符号类型，高4位表示符号的绑定特征。在/usr/include/elf.h文件中，有定义以下三个宏来获取类型或绑定特征的值或将它俩合成st_info的值：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define ELF32_ST_BIND(val)      (((unsigned char) (val)) &gt;&gt; 4)</span><br><span class="line">#define ELF32_ST_TYPE(val)      ((val) &amp; 0xf)</span><br><span class="line">#define ELF32_ST_INFO(bind, type)   (((bind) &lt;&lt; 4) + ((type) &amp; 0xf))</span><br></pre></td></tr></table></figure>
<h3 id="1-、绑定特征的可能取值如下所示：">(1)、绑定特征的可能取值如下所示：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#define STB_LOCAL   0       &#x2F;* Local symbol *&#x2F;</span><br><span class="line">#define STB_GLOBAL  1       &#x2F;* Global symbol *&#x2F;</span><br><span class="line">#define STB_WEAK    2       &#x2F;* Weak symbol *&#x2F;</span><br><span class="line">#define STB_NUM     3       &#x2F;* Number of defined types.  *&#x2F;</span><br><span class="line">#define STB_LOOS    10      &#x2F;* Start of OS-specific *&#x2F;</span><br><span class="line">#define STB_GNU_UNIQUE  10      &#x2F;* Unique symbol.  *&#x2F;</span><br><span class="line">#define STB_HIOS    12      &#x2F;* End of OS-specific *&#x2F;</span><br><span class="line">#define STB_LOPROC  13      &#x2F;* Start of processor-specific *&#x2F;</span><br><span class="line">#define STB_HIPROC  15      &#x2F;* End of processor-specific *&#x2F;</span><br></pre></td></tr></table></figure>
<h4 id="STB-LOCAL表示局部符号，STB-GLOBAL表示全局符号，STB-WEAK表示弱符号。">STB_LOCAL表示局部符号，STB_GLOBAL表示全局符号，STB_WEAK表示弱符号。</h4>
<h4 id="弱符号是全局符号，但它们的优先级相对全局符号低。">弱符号是全局符号，但它们的优先级相对全局符号低。</h4>
<h4 id="局部符号，顾名思义，它只被局限在定义它的目标文件之内，多个目标文件定义的同名局部符号互不影响，全局符号则与之相反。">局部符号，顾名思义，它只被局限在定义它的目标文件之内，多个目标文件定义的同名局部符号互不影响，全局符号则与之相反。</h4>
<h4 id="相对弱符号，其它的就是强符号。两个同名的强符号会导致重复定义的错误，但如果同名的是一个强符号和多个弱符号，则不报错，链接器会选择其中的强符号。">相对弱符号，其它的就是强符号。两个同名的强符号会导致重复定义的错误，但如果同名的是一个强符号和多个弱符号，则不报错，链接器会选择其中的强符号。</h4>
<h3 id="2-、符号类型的可能取值如下所示：">(2)、符号类型的可能取值如下所示：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define STT_NOTYPE  0       &#x2F;* Symbol type is unspecified *&#x2F;</span><br><span class="line">#define STT_OBJECT  1       &#x2F;* Symbol is a data object *&#x2F;</span><br><span class="line">#define STT_FUNC    2       &#x2F;* Symbol is a code object *&#x2F;</span><br><span class="line">#define STT_SECTION 3       &#x2F;* Symbol associated with a section *&#x2F;</span><br><span class="line">#define STT_FILE    4       &#x2F;* Symbol&#39;s name is file name *&#x2F;</span><br><span class="line">#define STT_COMMON  5       &#x2F;* Symbol is a common data object *&#x2F;</span><br><span class="line">#define STT_TLS     6       &#x2F;* Symbol is thread-local data object*&#x2F;</span><br><span class="line">#define STT_NUM     7       &#x2F;* Number of defined types.  *&#x2F;</span><br><span class="line">#define STT_LOOS    10      &#x2F;* Start of OS-specific *&#x2F;</span><br><span class="line">#define STT_GNU_IFUNC   10      &#x2F;* Symbol is indirect code object *&#x2F;</span><br><span class="line">#define STT_HIOS    12      &#x2F;* End of OS-specific *&#x2F;</span><br><span class="line">#define STT_LOPROC  13      &#x2F;* Start of processor-specific *&#x2F;</span><br><span class="line">#define STT_HIPROC  15      &#x2F;* End of processor-specific *&#x2F;</span><br></pre></td></tr></table></figure>
<h4 id="STT-NOTYPE表示未指定类型。每个符号表开头都有一个该类型的表项。">STT_NOTYPE表示未指定类型。每个符号表开头都有一个该类型的表项。</h4>
<h4 id="STT-OBJECT表示数据，如变量、数组等。">STT_OBJECT表示数据，如变量、数组等。</h4>
<h4 id="STT-FUNC表示函数或可执行代码。">STT_FUNC表示函数或可执行代码。</h4>
<h4 id="STT-SECTION表示一个section，该类型符号的绑定特征是STB-LOCAL。">STT_SECTION表示一个section，该类型符号的绑定特征是STB_LOCAL。</h4>
<h4 id="STT-FILE表示文件名。该类型符号的绑定特征是STB-LOCAL，st-shndx的值为SHN-ABS。">STT_FILE表示文件名。该类型符号的绑定特征是STB_LOCAL，st_shndx的值为SHN_ABS。</h4>
<h3 id="5、st-other表示符号的可见性，只使用了该成员的低2位。它的可能取值如下所示：">5、st_other表示符号的可见性，只使用了该成员的低2位。它的可能取值如下所示：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define STV_DEFAULT 	0       &#x2F;* Default symbol visibility rules *&#x2F;</span><br><span class="line">#define STV_INTERNAL    1       &#x2F;* Processor specific hidden class *&#x2F;</span><br><span class="line">#define STV_HIDDEN  	2       &#x2F;* Sym unavailable in other modules *&#x2F;</span><br><span class="line">#define STV_PROTECTED   3       &#x2F;* Not preemptible, not exported *&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="6、st-shndx表示符号所在的section对应的section-header的索引号。它有以下三个特殊值：">6、st_shndx表示符号所在的section对应的section header的索引号。它有以下三个特殊值：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define SHN_UNDEF   0       	&#x2F;* Undefined section *&#x2F;</span><br><span class="line">#define SHN_ABS     0xfff1      &#x2F;* Associated symbol is absolute *&#x2F;</span><br><span class="line">#define SHN_COMMON  0xfff2      &#x2F;* Associated symbol is common *&#x2F;</span><br></pre></td></tr></table></figure>
<h4 id="SHN-UNDEF表示该符号是未定义的，也就是说它可能定义在其他目标文件中，只有在程序执行时才能实际确定。对于索引值为STN-UNDEF的表项，st-shndx的值也是SHN-UNDEF。">SHN_UNDEF表示该符号是未定义的，也就是说它可能定义在其他目标文件中，只有在程序执行时才能实际确定。对于索引值为STN_UNDEF的表项，st_shndx的值也是SHN_UNDEF。</h4>
<h4 id="SHN-ABS表示该符号的值在重定位时不会改变。">SHN_ABS表示该符号的值在重定位时不会改变。</h4>
<h4 id="SHN-COMMON表示该符号尚未被分配空间，它的值st-value为地址对齐字节数。">SHN_COMMON表示该符号尚未被分配空间，它的值st_value为地址对齐字节数。</h4>
<h3 id="对于pwn来说，总之我们这里只要考虑st-name-st-info">对于pwn来说，总之我们这里只要考虑st_name, st_info</h3>
<h3 id="我们抽取最一般的规律，如下">我们抽取最一般的规律，如下</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">st_name &#x3D; 被调用函数名字符串地址的偏移</span><br><span class="line">st_info &#x3D; (0x1 &lt;&lt; 4) + 0x2 &#x2F;&#x2F; (STB_GLOBAL &lt;&lt; 4) + STT_FUNC</span><br><span class="line">&#x2F;&#x2F; 如果要绑定函数 st_info &#x3D; 0x12 例如:__libc_start_main</span><br><span class="line">&#x2F;&#x2F; 如果要绑定一般的指针 st_info &#x3D; 0x11 例如:stdin</span><br><span class="line">&#x2F;&#x2F; 如果要绑定变量 st_info &#x3D; 0x20 例如:__gmon_start__</span><br></pre></td></tr></table></figure>
<h3 id="对于其他的数据统统为0，如下">对于其他的数据统统为0，如下</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">被调用函数名字符串地址的偏移(4字节) 00 00 00 00 00 00 00 00 st_info(1字节) 00 00 00</span><br></pre></td></tr></table></figure>
<h3 id="这样我们学好了-dynstr和-dynsym结构体的知识">这样我们学好了.dynstr和.dynsym结构体的知识</h3>
<h3 id="接着我们学习-rel-plt，接着通过ida找到下面的数据，如下">接着我们学习.rel.plt，接着通过ida找到下面的数据，如下</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOAD:08048380                                                 ; ELF REL Relocation Table</span><br><span class="line">LOAD:08048380 F0 BF 04 08 06 04 00 00                                         Elf32_Rel &lt;804BFF0h, 406h&gt; ; R_386_GLOB_DAT stderr</span><br><span class="line">LOAD:08048388 F4 BF 04 08 06 07 00 00                                         Elf32_Rel &lt;804BFF4h, 706h&gt; ; R_386_GLOB_DAT __gmon_start__</span><br><span class="line">LOAD:08048390 F8 BF 04 08 06 09 00 00                                         Elf32_Rel &lt;804BFF8h, 906h&gt; ; R_386_GLOB_DAT stdin</span><br><span class="line">LOAD:08048398 FC BF 04 08 06 0A 00 00                                         Elf32_Rel &lt;804BFFCh, 0A06h&gt; ; R_386_GLOB_DAT stdout</span><br><span class="line">LOAD:080483A0                                                 ; ELF JMPREL Relocation Table</span><br><span class="line">LOAD:080483A0 0C C0 04 08 07 01 00 00                                         Elf32_Rel &lt;804C00Ch, 107h&gt; ; R_386_JMP_SLOT setbuf</span><br><span class="line">LOAD:080483A8 10 C0 04 08 07 02 00 00                                         Elf32_Rel &lt;804C010h, 207h&gt; ; R_386_JMP_SLOT read</span><br><span class="line">LOAD:080483B0 14 C0 04 08 07 03 00 00                                         Elf32_Rel &lt;804C014h, 307h&gt; ; R_386_JMP_SLOT printf</span><br><span class="line">LOAD:080483B8 18 C0 04 08 07 05 00 00                                         Elf32_Rel &lt;804C018h, 507h&gt; ; R_386_JMP_SLOT getchar</span><br><span class="line">LOAD:080483C0 1C C0 04 08 07 06 00 00                                         Elf32_Rel &lt;804C01Ch, 607h&gt; ; R_386_JMP_SLOT getpid</span><br><span class="line">LOAD:080483C8 20 C0 04 08 07 08 00 00                                         Elf32_Rel &lt;804C020h, 807h&gt; ; R_386_JMP_SLOT __libc_start_main</span><br></pre></td></tr></table></figure>
<h3 id="以上数据就是-rel-plt，从中我们可以提取出一个结构体，如下">以上数据就是.rel.plt，从中我们可以提取出一个结构体，如下</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Addr    r_offset;        &#x2F;4字节* Address * (这个就是got的地址[当然你可以自定义一个地址])&#x2F;</span><br><span class="line">  Elf32_Word    r_info;          &#x2F;4字节* Relocation type and symbol index *&#x2F;</span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>
<h3 id="简单说r-offset就是got地址">简单说r_offset就是got地址</h3>
<h3 id="接下来稍微简单说一下r-info">接下来稍微简单说一下r_info</h3>
<h4 id="r-info最低位为6则是变量，为7则是函数">r_info最低位为6则是变量，为7则是函数</h4>
<h4 id="r-info第二位开始为-dynsym的位置，这个位置是以下代码的位置开始的，其实本质上就是-dynsym的头部，然后相对于这个头部取偏移，然后每个偏移的长度为0x10，因为一个-dynsym的长度为0x10">r_info第二位开始为.dynsym的位置，这个位置是以下代码的位置开始的，其实本质上就是.dynsym的头部，然后相对于这个头部取偏移，然后每个偏移的长度为0x10，因为一个.dynsym的长度为0x10</h4>
<pre><code>LOAD:0804820C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                 Elf32_Sym &lt;0&gt;
</code></pre>
<h3 id="所以总结一下">所以总结一下</h3>
<h4 id="如果要绑定变量-r-info-fake-dynsym-dynsym-head-0x10-8-0x6">如果要绑定变量 r_info = (((fake_dynsym - dynsym_head) / 0x10) &lt;&lt; 8) | 0x6;</h4>
<h4 id="如果要绑定函数-r-info-fake-dynsym-dynsym-head-0x10-8-0x7">如果要绑定函数 r_info = (((fake_dynsym - dynsym_head) / 0x10) &lt;&lt; 8) | 0x7</h4>
<h3 id="接下来就是reloc-offset的取值问题">接下来就是reloc_offset的取值问题</h3>
<h4 id="这里直接给出规律-reloc-offset-fake-rel-plt-rel-plt-head">这里直接给出规律 reloc_offset = fake_rel_plt - rel_plt_head</h4>
<h3 id="总结一下结构体伪造的步骤">总结一下结构体伪造的步骤</h3>
<h4 id="1、在bss段构造dynsym顺便把函数名也放到后面，接着继续在函数名后面继续构造-rel-plt">1、在bss段构造dynsym顺便把函数名也放到后面，接着继续在函数名后面继续构造.rel.plt</h4>
<h4 id="2、通过栈迁移，将reloc-offset和参数放到栈的位置里，然后跳到plt-jmp绑定函数的plt上就可以触发dl-runtime-resolve然后通过-fix-up来任意函数调用">2、通过栈迁移，将reloc_offset和参数放到栈的位置里，然后跳到plt_jmp绑定函数的plt上就可以触发dl_runtime_resolve然后通过_fix_up来任意函数调用</h4>
<h3 id="参考了部分原文链接：https-blog-csdn-net-npy-lp-article-details-102704732">参考了部分原文链接：<a href="https://blog.csdn.net/npy_lp/article/details/102704732" target="_blank" rel="noopener">https://blog.csdn.net/npy_lp/article/details/102704732</a></h3>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:196011564@qq.com">咲夜南梦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/">http://yoursite.com/2020/02/07/CTF-Pwn-dl_resolve%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">咲夜南梦's 博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF    </a><a class="post-meta__tags" href="/tags/Pwn/">Pwn    </a></div><div class="post_share"><div class="social-share" data-image="/2020/03/22/Vue-入门/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/02/14/Python-subprocess%E6%A8%A1%E5%9D%97%E8%AF%A6%E8%A7%A3/"><img class="prev_cover lazyload" data-src="/2020/02/14/Python-subprocess模块详解/bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python-subprocess模块详解</div></div></a></div><div class="next-post pull_right"><a href="/2020/01/30/CTF%E5%A0%86%E6%94%BB%E5%87%BB%E5%A4%A7%E5%85%A8/"><img class="next_cover lazyload" data-src="/2020/01/30/CTF堆攻击大全/bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CTF堆攻击大全</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/12/07/CTF-JarvisOJ-Basic-ROPGadget/" title="CTF-JarvisOJ-Basic-ROPGadget"><img class="relatedPosts_cover lazyload"data-src="/2018/12/07/CTF-JarvisOJ-Basic-ROPGadget/2.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-12-07</div><div class="relatedPosts_title">CTF-JarvisOJ-Basic-ROPGadget</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/27/CTF-JarvisOJ-Basic-Shellcode/" title="CTF-JarvisOJ-Basic-Shellcode"><img class="relatedPosts_cover lazyload"data-src="/2018/11/27/CTF-JarvisOJ-Basic-Shellcode/2.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-27</div><div class="relatedPosts_title">CTF-JarvisOJ-Basic-Shellcode</div></div></a></div><div class="relatedPosts_item"><a href="/2018/12/12/CTF-JarvisOJ-Pwn-[61dctf]fm/" title="CTF-JarvisOJ-Pwn-[61dctf]fm"><img class="relatedPosts_cover lazyload"data-src="/2018/12/12/CTF-JarvisOJ-Pwn-[61dctf]fm/5.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-12-12</div><div class="relatedPosts_title">CTF-JarvisOJ-Pwn-[61dctf]fm</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/30/CTF-JarvisOJ-Pwn-[XMAN]level0/" title="CTF-JarvisOJ-Pwn-[XMAN]level0"><img class="relatedPosts_cover lazyload"data-src="/2018/11/30/CTF-JarvisOJ-Pwn-[XMAN]level0/9.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-30</div><div class="relatedPosts_title">CTF-JarvisOJ-Pwn-[XMAN]level0</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/30/CTF-JarvisOJ-Pwn-[XMAN]level1/" title="CTF-JarvisOJ-Pwn-[XMAN]level1"><img class="relatedPosts_cover lazyload"data-src="/2018/11/30/CTF-JarvisOJ-Pwn-[XMAN]level1/7.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-30</div><div class="relatedPosts_title">CTF-JarvisOJ-Pwn-[XMAN]level1</div></div></a></div><div class="relatedPosts_item"><a href="/2019/04/14/CTF-JarvisOJ-Pwn-[XMAN]level3_x64/" title="CTF-JarvisOJ-Pwn-[XMAN]level3_x64"><img class="relatedPosts_cover lazyload"data-src="/2019/04/14/CTF-JarvisOJ-Pwn-[XMAN]level3_x64/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-04-14</div><div class="relatedPosts_title">CTF-JarvisOJ-Pwn-[XMAN]level3_x64</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '560d606afb5e3201949f',
  clientSecret: 'adf278d9baa268981569ab6db3020b28d99f2aec',
  repo: '196011564.github.io',
  owner: '196011564',
  admin: ['196011564'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 咲夜南梦</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>